<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Real-Time Commute Predictor</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body class="h-screen w-screen overflow-hidden bg-slate-900 text-white">

<div class="flex h-full w-full">

  <!-- LEFT PANEL -->
  <div class="w-[420px] min-w-[360px] bg-slate-900/90 backdrop-blur-xl border-r border-white/10 p-6 flex flex-col">

    <h1 class="text-2xl font-extrabold mb-1">ðŸš¦ Real-Time Commute Predictor</h1>
    <p class="text-slate-400 text-sm mb-6">Commute simulation with live ETA</p>

    <div class="space-y-4">
      <input id="source" placeholder="Source (e.g. Connaught Place, Delhi)"
        class="w-full px-4 py-3 rounded bg-black/40 border border-white/10"/>

      <input id="destination" placeholder="Destination (e.g. Sector 62, Noida)"
        class="w-full px-4 py-3 rounded bg-black/40 border border-white/10"/>

      <button id="btn" onclick="getETA()"
        class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded font-semibold">
        Predict & Simulate
      </button>
    </div>

    <div id="loading" class="hidden mt-4 text-slate-400">
      Loading routeâ€¦
    </div>

    <div id="result" class="hidden mt-4 space-y-1 text-sm">
      <div>Distance: <span id="distance"></span></div>
      <div>Duration: <span id="normal"></span></div>
      <div class="text-green-400">ETA: <span id="traffic"></span></div>
    </div>

    <div id="error" class="hidden mt-4 text-red-400 text-sm"></div>
  </div>

  <!-- MAP -->
  <div id="map" class="flex-1"></div>
</div>

<script>
/* -------------------- DOM -------------------- */
const sourceInput = document.getElementById("source");
const destinationInput = document.getElementById("destination");
const loading = document.getElementById("loading");
const result = document.getElementById("result");
const error = document.getElementById("error");
const distance = document.getElementById("distance");
const normal = document.getElementById("normal");
const traffic = document.getElementById("traffic");

/* -------------------- MAP -------------------- */
let map = L.map("map").setView([28.6139, 77.2090], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

/* -------------------- STATE -------------------- */
let routeLayer = null;
let vehicleMarker = null;
let simulationTimer = null;
let route = [];
let step = 0;
let totalDistance = 0;
let totalDuration = 0;

const POINTS_PER_TICK = 50;
const TICK_INTERVAL = 1000;

/* -------------------- CAR ICON (FIXED) -------------------- */
const carIcon = L.divIcon({
  html: `<div style="
    font-size: 28px;
    transform: translate(-50%, -50%);
  ">ðŸš—</div>`,
  iconSize: [28, 28],
  iconAnchor: [14, 14],
  className: ""
});

/* -------------------- HELPERS -------------------- */
function haversine(a, b) {
  const R = 6371;
  const dLat = (b[0] - a[0]) * Math.PI / 180;
  const dLon = (b[1] - a[1]) * Math.PI / 180;
  const la1 = a[0] * Math.PI / 180;
  const la2 = b[0] * Math.PI / 180;

  return 2 * R * Math.asin(Math.sqrt(
    Math.sin(dLat / 2) ** 2 +
    Math.cos(la1) * Math.cos(la2) *
    Math.sin(dLon / 2) ** 2
  ));
}

/* -------------------- MAIN -------------------- */
async function getETA() {
  const s = sourceInput.value.trim();
  const d = destinationInput.value.trim();
  if (!s || !d) return;

  error.classList.add("hidden");
  result.classList.add("hidden");
  loading.classList.remove("hidden");

  if (simulationTimer) clearInterval(simulationTimer);
  if (routeLayer) map.removeLayer(routeLayer);
  if (vehicleMarker) map.removeLayer(vehicleMarker);

  const res = await fetch(`/eta?source=${encodeURIComponent(s)}&destination=${encodeURIComponent(d)}`);
  const data = await res.json();

  loading.classList.add("hidden");

  if (!res.ok) {
    error.textContent = data.detail || "Error fetching route";
    error.classList.remove("hidden");
    return;
  }

  route = data.geometry;
  step = 0;
  totalDistance = parseFloat(data.distance);
  totalDuration = parseFloat(data.duration_normal);

  distance.textContent = data.distance;
  normal.textContent = data.duration_normal;
  traffic.textContent = data.duration_in_traffic;
  result.classList.remove("hidden");

  routeLayer = L.polyline(route, {
    color: "#3b82f6",
    weight: 5
  }).addTo(map);

  map.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });

  vehicleMarker = L.marker(route[0], { icon: carIcon })
    .addTo(map)
    .bindPopup("ðŸš— Vehicle")
    .openPopup();

  startSimulation();
}

/* -------------------- SIMULATION -------------------- */
function startSimulation() {
  if (simulationTimer) clearInterval(simulationTimer);

  simulationTimer = setInterval(() => {

    // Move multiple steps per tick
    step += POINTS_PER_TICK;

    // Reached destination
    if (step >= route.length - 1) {
      step = route.length - 1;
      vehicleMarker.setLatLng(route[step]);
      clearInterval(simulationTimer);
      vehicleMarker.bindPopup("âœ… Reached Destination").openPopup();
      return;
    }

    // Move vehicle
    vehicleMarker.setLatLng(route[step]);
    map.panTo(route[step], { animate: true, duration: 0.5 });

    // ---- Distance calculation ----
    let covered = 0;
    for (let i = 0; i < step; i++) {
      covered += haversine(route[i], route[i + 1] || route[i]);
    }

    const remaining = Math.max(totalDistance - covered, 0);
    const eta = (remaining / totalDistance * totalDuration).toFixed(1);

    distance.textContent = remaining.toFixed(2) + " km";
    normal.textContent = eta + " mins";
    traffic.textContent = eta + " mins";

  }, TICK_INTERVAL);
}

</script>

</body>
</html>

